<!DOCTYPE html>
<html lang="en">

<head>

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DB Refresh Tool | DataSolveX</title>
    <link rel="stylesheet" href="../static/global.css">
    <link rel="stylesheet" href="../static/db_refresh.css">
    <link rel="stylesheet" href="../static/replication.css">


    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>

    <style>
      /* Sticky footer base layout */

      html,
      body {

        height: 100%;

      }

      body {

        margin: 0;

        min-height: 100vh;

        display: flex;

        flex-direction: column;

      }

      /* Your page content wrapper must grow */

      .page-wrapper,
      main {

        flex: 1;

      }

      /* Footer sticks to bottom */

      .site-footer {

        margin-top: auto;

        padding: 12px 24px;

        border-top: 1px solid rgba(148, 163, 184, 0.4);

        background: #f3f4f6;

        color: #4b5563;

        font-size: 13px;

      }
    </style>
  </head>
</head>

<main>

  <body>
    <header class="app-header">
      <!-- Top Navigation Bar -->
      <nav class="app-nav">
        <div class="app-nav-container">
          <a href="{{ url_for('index') }}" class="app-brand">DataSolveX</a>
          <ul class="app-nav-menu">
            <li><a href="{{ url_for('index') }}" class="app-nav-link">Home</a></li>
          </ul>
        </div>
      </nav>

      <div class="app-breadcrumb">
        <div class="app-breadcrumb-container">
          <ul class="breadcrumb-list">
            <li class="breadcrumb-item">
              <a href="{{ url_for('index') }}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Home
              </a>
            </li>
            <li class="breadcrumb-item">
              <a href="{{ url_for('sqlserver_main') }}">Microsoft SQL Server</a>
            </li>
            <li class="breadcrumb-item active">Staging Server</li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <h3>Search for a Staging Server</h3>
      <input type="text" id="serverName" placeholder="Enter server name..." />
      <button onclick="searchServer()">Search</button>

      <div id="dbList" class="db-list"></div>
    </div>
</main>
<footer class="footer">
  <div style="display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap;">
    <div class="footer-bottom">
      DataSolveX
    </div>
  </div>
</footer>


<script>
  function searchServer() {
    const serverName = document.getElementById("serverName").value;
    const dbList = document.getElementById("dbList");
    dbList.innerHTML = ""; // Clear previous results

    if (!serverName) {
      alert("Please enter a server name.");
      return;
    }

    // Encode the server name to handle special characters like backslash
    const encodedServerName = encodeURIComponent(serverName);

    fetch(`/search_servers?query=${encodedServerName}`)
      .then((response) => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error("No databases found or invalid server.");
        }
      })
      .then((data) => {
        const server = Object.keys(data)[0];
        const databases = data[server];

        if (databases.length > 0) {
          // Add heading before listing databases
          const heading = document.createElement("h4");
          heading.textContent = "List of Databases in Staging server";
          dbList.appendChild(heading);

          databases.forEach((db) => {
            const dbItem = document.createElement("div");
            dbItem.className = "db-item";
            dbItem.textContent = db;
            dbItem.onclick = () =>
              (window.location.href = `/database_page?server=${server}&database=${db}`);
            dbList.appendChild(dbItem);
          });
        } else {
          dbList.innerHTML = "<p>No databases found for this server.</p>";
        }
      })

      .catch((error) => {
        dbList.innerHTML = `<p>Error: ${error.message}</p>`;
      });
  }
</script>
<script>
  window.addEventListener('beforeunload', function () {
    const data = JSON.stringify({
      page: window.location.pathname,
      timestamp: new Date().toISOString()
    });

    // ðŸ‘‡ This is CRITICAL: content type must be application/json
    const blob = new Blob([data], { type: 'application/json' });
    navigator.sendBeacon('/log-exit', blob);
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const now = new Date().toISOString();
    const page = window.location.pathname;

    fetch('/log-entry', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        page: page,
        timestamp: now
      })
    });
  });
</script>

  <script src="/static/js/page_exit_beacon.js" defer></script>
</body>

</html>