<!DOCTYPE html>
<html lang="en">
 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Clone Management - DataSolveX</title>
 
    <link rel="stylesheet" href="{{ url_for('static', filename='userclone/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='/global.css') }}">
 
    <style>
        .wide-grid {
            display: flex;
            gap: 18px;
            width: 100%;
        }
 
        .wide-grid .form-group {
            flex: 1;
            min-width: 0;
        }
 
        #settingsOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            justify-content: flex-end;
            align-items: flex-start;
            z-index: 3000;
            opacity: 0;
            transition: opacity .2s ease;
        }
 
        .settings-panel {
            width: 320px;
            background: #fff;
            padding: 20px;
            border-radius: 0 0 0 8px;
            margin-top: 40px;
            box-shadow: -4px 0 18px rgba(0, 0, 0, .18);
            animation: slideIn .25s ease;
        }
 
        @keyframes slideIn {
            from { transform: translateX(120%); }
            to { transform: translateX(0); }
        }
 
        .output-pane {
            height: 150px;
            overflow: auto;
            background: #0b1220;
            color: #e6f7ff;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
 
        .progress-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
 
        .progress {
            flex: 1;
            background: rgba(255, 255, 255, 0.12);
            height: 10px;
            border-radius: 999px;
            overflow: hidden;
        }
 
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width .3s ease;
        }
 
        .percent-text {
            min-width: 40px;
            text-align: right;
            font-weight: 700;
            font-size: 13px;
        }
 
        .duration-text {
            min-width: 60px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
 
        .error-tooltip {
            color: #7f1d1d;
            font-size: .85rem;
            margin-top: 4px;
        }
 
        .btn-small {
            width: 160px;
            padding: 8px 0;
            font-size: 15px;
            margin-top: 14px;
        }
 
        #logsPopup {
            display: none;
        }
 
        .filter-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #fff;
            color: #0f172a;
            box-sizing: border-box;
            transition: border-color .15s ease, box-shadow .15s ease;
        }
 
        .filter-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
        }
 
        .filter-input::placeholder {
            color: #94a3b8;
        }
 
        .filter-select {
            width: 100%;
            padding: 4px 6px;
            font-size: 13px;
        }
 
        .filter-icon {
            margin-left: 4px;
            cursor: pointer;
            font-size: 11px;
        }
 
        #startTimeFilterPanel,
        #valTimeFilterPanel {
            position: fixed;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            z-index: 6001;
            display: none;
            min-width: 180px;
        }
 
        #startTimeFilterPanel label,
        #valTimeFilterPanel label {
            display: block;
            font-size: 12px;
            margin-bottom: 6px;
        }
 
        #startTimeFilterPanel input[type="date"],
        #valTimeFilterPanel input[type="date"] {
            width: 100%;
            box-sizing: border-box;
        }
 
        #startTimeFilterPanel button,
        #valTimeFilterPanel button {
            font-size: 12px;
            padding: 3px 8px;
            margin-left: 4px;
        }
    </style>
</head>
 
<body>
 
    <!-- LOGS POPUP -->
    <div id="logsPopup" style="
    position:fixed; inset:0;
    background:rgba(0,0,0,0.45);
    display:none; z-index:5000;
    justify-content:center; align-items:center;
">
        <div style="
        background:white; width:90%; max-width:1200px;
        max-height:80vh; border-radius:8px;
        padding:20px; display:flex; flex-direction:column;
        box-shadow:0 0 25px rgba(0,0,0,0.3);
    ">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 class="font-weight-bold" style="margin:0;">Execution Logs</h3>
                <button id="closeLogsPopup" style="
                background:none; border:none;
                font-size:26px; cursor:pointer; line-height:20px;
            ">&times;</button>
            </div>
 
            <div id="logsScroll" style="
            overflow:auto; border:1px solid #ccc;
            border-radius:6px; padding:0; background:white; flex:1;
        ">
                <table id="logsTable" class="recent-table" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th>Executed By</th>
                            <th>Start Time <span class="filter-icon" id="startTimeFilterIcon">‚ñº</span></th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Execution Mode</th>
                            <th>Execution Status</th>
                        </tr>
 
                        <tr>
                            <th><select id="filterExecBy" class="filter-select">
                                    <option value="">All</option>
                                </select></th>
 
                            <th>
                                <select id="filterStart" class="filter-select">
                                    <option value="">All</option>
                                    <option value="24h">Last 24 Hours</option>
                                    <option value="7d">Last 7 Days</option>
                                    <option value="thisweek">This Week</option>
                                    <option value="thismonth">This Month</option>
                                </select>
                            </th>
 
                            <th></th>
                            <th></th>
 
                            <th><select id="filterMode" class="filter-select">
                                    <option value="">All</option>
                                </select></th>
 
                            <th>
                                <select id="filterStatus" class="filter-select">
                                    <option value="">All</option>
                                    <option value="success">Success</option>
                                    <option value="failure">Failure</option>
                                </select>
                            </th>
                        </tr>
                    </thead>
 
                    <tbody id="logsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
 
    <!-- VALIDATION POPUP -->
    <div id="validatePopup" style="
    position:fixed; inset:0;
    background:rgba(0,0,0,0.45);
    display:none; z-index:5000;
    justify-content:center; align-items:center;
">
        <div style="
        background:white; width:90%; max-width:1200px;
        max-height:80vh; border-radius:8px;
        padding:20px; display:flex; flex-direction:column;
        box-shadow:0 0 25px rgba(0,0,0,0.3);
    ">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 class="font-weight-bold" style="margin:0;">Clone Validation</h3>
                <button id="closeValidatePopup" style="
                background:none; border:none;
                font-size:26px; cursor:pointer; line-height:20px;
            ">&times;</button>
            </div>
 
            <div style="
            display:flex; gap:12px; align-items:flex-start;
            padding:10px; border:1px solid #e5e7eb; border-radius:8px;
            background:#f8fafc; margin-bottom:12px;
        ">
                <div style="min-width:420px; flex:1;">
                    <label style="font-weight:600; font-size:13px; display:block; margin-bottom:6px;">
                        Text File Path
                    </label>
 
                    <input id="val_file_path" type="text" class="filter-input" placeholder="C:\path\to\clone.txt">
 
                    <div id="valPathHint" style="
                        margin-top:6px;
                        font-size:12px;
                        color:#475569;
                        display:none;
                    "></div>
 
                    <div id="valPathError" class="error-tooltip" style="display:none"></div>
                </div>
 
                <div style="display:flex; flex-direction:row; gap:8px; margin-top:22px; white-space:nowrap;">
                    <button type="button" id="applyValPairsBtn" class="btn-secondary" style="padding:10px 14px;">
                        Apply
                    </button>
                    <button type="button" id="clearValPairsBtn" class="btn-secondary" style="padding:10px 14px;">
                        Clear
                    </button>
                    <span id="valPairsChip" style="
                    display:none; padding:6px 10px; border-radius:999px;
                    background:#eef2ff; color:#1e3a8a; font-weight:700; font-size:12px;
                    text-align:center;
                ">0 pairs</span>
                </div>
            </div>
 
            <div id="validateScroll" style="
            overflow:auto; border:1px solid #ccc;
            border-radius:6px; padding:0; background:white; flex:1;
        ">
                <table id="validateTable" class="recent-table" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th>Old User</th>
                            <th>New User</th>
                            <th>Status</th>
                            <th>Timestamp <span class="filter-icon" id="valTimeFilterIcon">‚ñº</span></th>
                            <th>Remarks</th>
                        </tr>
 
                        <tr>
                            <th><input id="filterOldUser" class="filter-input" placeholder="Search old user"></th>
                            <th><input id="filterNewUser" class="filter-input" placeholder="Search new user"></th>
                            <th>
                                <select id="filterValStatus" class="filter-select">
                                    <option value="">All</option>
                                    <option value="success">Success</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </th>
                            <th>
                                <select id="filterValTime" class="filter-select">
                                    <option value="">All</option>
                                    <option value="24h">Last 24 Hours</option>
                                    <option value="7d">Last 7 Days</option>
                                    <option value="thisweek">This Week</option>
                                    <option value="thismonth">This Month</option>
                                </select>
                            </th>
                            <th><input id="filterRemarks" class="filter-input" placeholder="Search remarks"></th>
                        </tr>
                    </thead>
 
                    <tbody id="validateBody"></tbody>
                </table>
            </div>
        </div>
    </div>
 
    <div id="startTimeFilterPanel">
        <div style="font-weight:600;font-size:12px;margin-bottom:4px;">Start Time Range</div>
        <label>From
            <input type="date" id="startDate">
        </label>
        <label>To
            <input type="date" id="endDate">
        </label>
        <div style="text-align:right;margin-top:4px;">
            <button type="button" id="applyStartDateFilter">Apply</button>
            <button type="button" id="clearStartDateFilter">Clear</button>
        </div>
    </div>
 
    <div id="valTimeFilterPanel">
        <div style="font-weight:600;font-size:12px;margin-bottom:4px;">Timestamp Range</div>
        <label>From
            <input type="date" id="valStartDate">
        </label>
        <label>To
            <input type="date" id="valEndDate">
        </label>
        <div style="text-align:right;margin-top:4px;">
            <button type="button" id="applyValDateFilter">Apply</button>
            <button type="button" id="clearValDateFilter">Clear</button>
        </div>
    </div>
 
    <header class="app-header">
        <div class="app-nav">
            <div class="app-nav-container">
                <a href="{{ url_for('index') }}" class="app-brand">DataSolveX</a>
                <ul class="app-nav-menu"></ul>
            </div>
        </div>
 
        <div class="app-breadcrumb">
            <div class="app-breadcrumb-container">
                <ul class="breadcrumb-list">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('sqlserver_main') }}">SQL Server Main</a>
                    </li>
                    <li class="breadcrumb-item active">User Clone Management</li>
                </ul>
 
                <ul class="breadcrumb-actions">
                    <li><a class="nav-link" id="settingsBtn">Settings</a></li>
                    <li><a class="nav-link" id="logsBtn">Logs</a></li>
                    <li><a class="nav-link" id="validateBtn">Validate</a></li>
                </ul>
            </div>
        </div>
    </header>
 
    <div id="mainPage">
        <div class="container" style="padding-top:20px;">
            <h2 class="text-center">User Clone Management</h2>
 
            <div class="card-glass" style="max-width:1200px;margin:25px auto;padding:25px;">
                <form id="cloneForm" enctype="multipart/form-data" novalidate>
 
                    <h3 class="font-weight-bold" style="margin-bottom:8px;">Configuration</h3>
 
                    <div class="wide-grid">
                        <div class="form-group">
                            <label>
                                Source Server
                                <span class="info-container">
                                    <span class="info-icon">i</span>
                                    <span class="info-tooltip">SQL Server instance where the original user exists.</span>
                                </span>
                            </label>
 
                            <input type="text" id="server">
                            <div id="serverError" class="error-tooltip" style="display:none"></div>
                        </div>
 
                        <div class="form-group">
                            <label>
                                Staging Database
                                <span class="info-container">
                                    <span class="info-icon">i</span>
                                    <span class="info-tooltip">Database used to store temporary staging data during cloning.</span>
                                </span>
                            </label>
 
                            <select id="database"></select>
                            <div id="dbError" class="error-tooltip" style="display:none"></div>
                        </div>
 
                        <div class="form-group">
                            <label>
                                Logging Server
                                <span class="info-container">
                                    <span class="info-icon">i</span>
                                    <span class="info-tooltip">Server where log data is stored. Configured in Settings.</span>
                                </span>
                            </label>
 
                            <input type="text" id="logServer" readonly>
                        </div>
 
                        <div class="form-group">
                            <label>
                                Logging Database
                                <span class="info-container">
                                    <span class="info-icon">i</span>
                                    <span class="info-tooltip">Database used for storing cloned-user logs. Configured in Settings.</span>
                                </span>
                            </label>
 
                            <input type="text" id="logDB" readonly>
                        </div>
                    </div>
 
                    <div class="divider" style="margin:20px 0;"></div>
 
                    <h3 class="font-weight-bold">
                        Execution Mode
                        <span class="info-container">
                            <span class="info-icon">i</span>
                            <span class="info-tooltip">Select how you want to run the cloning.</span>
                        </span>
                    </h3>
 
                    <div style="display:flex;gap:30px;align-items:center;">
                        <label>
                            <input type="radio" id="singleRadio" name="mode" value="Single"> Single Login Clone
                        </label>
 
                        <label>
                            <input type="radio" id="multiRadio" name="mode" value="Multiple"> Bulk Login Clone
                        </label>
                    </div>
 
                    <div id="singleUserBlock" class="wide-grid d-none" style="margin-top:12px;">
                        <div class="form-group">
                            <label>Source Login</label>
                            <input type="text" id="old_user">
                        </div>
                        <div class="form-group">
                            <label>Target Login</label>
                            <input type="text" id="new_user">
                        </div>
                    </div>
 
                    <div id="multiUserBlock" class="d-none" style="margin-top:12px;">
                        <label>Text File Path</label>
                        <input type="text" id="user_file_path" placeholder="C:\path\to\clone.txt" style="width:420px;" />
                        <div id="fileError" class="error-tooltip" style="display:none"></div>
                        <div id="bulkPathHint" style="display:none; font-size:12px; color:#475569; margin-top:6px;"></div>
                    </div>
 
                    <button type="button" id="submitBtn" class="btn-primary btn-small">Execute Clone</button>
 
                    <div style="margin-top:18px;">
                        <div style="font-weight:600;margin-bottom:6px;">Execution Console</div>
                        <div id="output" class="output-pane"></div>
 
                        <div class="progress-wrap">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar"></div>
                            </div>
                            <div class="percent-text" id="percentText">0%</div>
                            <div class="duration-text" id="durationText">00:00</div>
                        </div>
                    </div>
 
                </form>
            </div>
 
            <div class="card-glass recent-exec-card" style="padding:20px;">
                <h3 class="font-weight-bold">Recent Executions</h3>
 
                <table class="recent-table" style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th>Executed By</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Execution Mode</th>
                            <th>Execution Status</th>
                        </tr>
                    </thead>
                    <tbody id="recentExecBody"></tbody>
                </table>
            </div>
 
        </div>
    </div>
 
    <div id="settingsOverlay">
        <div class="settings-panel">
            <div class="settings-header" style="display:flex;justify-content:space-between;">
                <div class="settings-title">Logging Configuration</div>
                <button id="closeSettings" class="settings-close">&times;</button>
            </div>
 
            <div class="form-group">
                <label>Logging Server</label>
                <input type="text" id="setLogServer">
                <div id="setLogServerError" class="error-tooltip" style="display:none"></div>
            </div>
 
            <div class="form-group">
                <label>Logging Database</label>
                <input type="text" id="setLogDB">
                <div id="setLogDBError" class="error-tooltip" style="display:none"></div>
            </div>
 
            <div class="settings-footer" style="display:flex;gap:10px;margin-top:20px;position:relative;">
                <button id="testConn" class="btn-secondary">Test Connection</button>
                <button id="saveSettings" class="btn-primary" disabled>Save</button>
 
                <span id="saveTooltip" class="info-tooltip save-tooltip">
                    Test connection successfully to enable Save
                </span>
            </div>
        </div>
    </div>
 
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; User Clone Management ‚óè DataSolveX</p>
        </div>
    </footer>
 
    <div id="errorModal">
        <div id="errorModalContent">
            <div id="errorModalHeader">
                <span>Execution Error</span>
                <button id="errorModalClose">&times;</button>
            </div>
            <div id="errorModalBody"></div>
        </div>
    </div>

    <script>
        let loggingTestPassed = false;
        const dbSelect = document.getElementById("database");
        const fileError = document.getElementById("fileError");
 
        let errorSource = null;
 
        // ---------- Top nav actions ----------
        document.getElementById("logsBtn").onclick = () => {
            loadLogs().then(() => {
                document.getElementById("logsPopup").style.display = "flex";
            });
        };
 
        document.getElementById("closeLogsPopup").onclick = () => {
            document.getElementById("logsPopup").style.display = "none";
        };
 
        // Single brand handler (you had duplicates earlier)
        document.querySelector(".app-brand").addEventListener("click", () => {
            document.getElementById("logsPopup").style.display = "none";
            document.getElementById("validatePopup").style.display = "none";
            document.getElementById("errorModal").style.display = "none";
            errorSource = null;
            document.getElementById("mainPage").style.display = "block";
        });
 
        // ---------- Settings overlay ----------
        const overlay = document.getElementById("settingsOverlay");
        const settingsBtn = document.getElementById("settingsBtn");
        const closeSettings = document.getElementById("closeSettings");
        const saveSettings = document.getElementById("saveSettings");
 
        saveSettings.disabled = true;
 
        const logServer = document.getElementById("logServer");
        const logDB = document.getElementById("logDB");
        const setLogServer = document.getElementById("setLogServer");
        const setLogDB = document.getElementById("setLogDB");
 
        settingsBtn.onclick = () => {
            overlay.style.display = "flex";
            requestAnimationFrame(() => overlay.style.opacity = "1");
 
            setLogServer.value = logServer.value;
            setLogDB.value = logDB.value;
 
            loggingTestPassed = false;
            saveSettings.disabled = true;
        };
 
        function showValPathError(msg) {
            const e = document.getElementById("valPathError");
            e.textContent = msg || "";
            e.style.display = msg ? "block" : "none";
        }
 
        function invalidateLoggingTest() {
            loggingTestPassed = false;
            saveSettings.disabled = true;
        }
 
        setLogServer.addEventListener("input", invalidateLoggingTest);
        setLogDB.addEventListener("input", invalidateLoggingTest);
 
        closeSettings.onclick = () => {
            overlay.style.opacity = "0";
            setTimeout(() => overlay.style.display = "none", 200);
        };
 
        saveSettings.onclick = async () => {
            if (saveSettings.disabled) return;
 
            const server = setLogServer.value.trim();
            const db = setLogDB.value.trim();
 
            const fd = new FormData();
            fd.append("logging_server", server);
            fd.append("logging_database", db);
 
            const res = await fetch("{{ url_for('userclone.save_logging_settings') }}", {
                method: "POST",
                body: fd
            });
 
            const data = await res.json();
            if (!data.success) {
                alert("Failed to save logging config");
                return;
            }
 
            logServer.value = server;
            logDB.value = db;
            closeSettings.onclick();
        };
 
        document.getElementById("testConn").onclick = async () => {
            const server = setLogServer.value.trim();
            const database = setLogDB.value.trim();
 
            const srvErr = document.getElementById("setLogServerError");
            const dbErr = document.getElementById("setLogDBError");
 
            srvErr.style.display = "none";
            dbErr.style.display = "none";
 
            loggingTestPassed = false;
            saveSettings.disabled = true;
 
            if (!server) {
                srvErr.textContent = "Logging server required";
                srvErr.style.display = "block";
                return;
            }
            if (!database) {
                dbErr.textContent = "Logging database required";
                dbErr.style.display = "block";
                return;
            }
 
            const fd = new FormData();
            fd.append("server", server);
            fd.append("database", database);
 
            const res = await fetch("{{ url_for('userclone.test_connection') }}", {
                method: "POST",
                body: fd
            });
 
            const data = await res.json();
 
            alert((data.success ? "SUCCESS:\n" : "FAILURE:\n") + data.message);
 
            if (data.success) {
                loggingTestPassed = true;
                saveSettings.disabled = false;
            }
        };
 
        // ---------- Server validation / DB list ----------
        let serverValidated = false;
        let serverValidating = false;
        let lastValidatedServer = "";
 
        let dbFetchController = null;
        let dbFetchSeq = 0;
 
        async function validateServerIfNeeded() {
            const serverInput = document.getElementById("server");
            const serverError = document.getElementById("serverError");
            const serverVal = serverInput.value.trim();
 
            if (serverVal.toLowerCase() !== lastValidatedServer.toLowerCase()) {
                serverValidated = false;
            }
 
            if (!serverVal) {
                serverError.textContent = "Server is required";
                serverError.style.display = "block";
                serverValidated = false;
 
                dbSelect.innerHTML = `<option value="">-- Select Database --</option>`;
                dbSelect.value = "";
                return false;
            }
 
            if (serverValidated && serverVal.toLowerCase() === lastValidatedServer.toLowerCase()) {
                return true;
            }
 
            if (dbFetchController) {
                try { dbFetchController.abort(); } catch { }
            }
            dbFetchController = new AbortController();
 
            const mySeq = ++dbFetchSeq;
 
            serverValidating = true;
            serverError.textContent = "Invalid Server";
            serverError.style.display = "block";
 
            try {
                const fd = new FormData();
                fd.append("server", serverVal);
 
                const res = await fetch("{{ url_for('userclone.get_databases') }}", {
                    method: "POST",
                    body: fd,
                    signal: dbFetchController.signal
                });
 
                if (mySeq !== dbFetchSeq) return false;
 
                const data = await res.json();
 
                if (!data.success) {
                    serverError.textContent = data.message || "Invalid server";
                    serverError.style.display = "block";
 
                    serverValidated = false;
                    lastValidatedServer = "";
 
                    dbSelect.innerHTML = `<option value="">-- Select Database --</option>`;
                    dbSelect.value = "";
                    return false;
                }
 
                serverError.style.display = "none";
                serverError.textContent = "";
 
                dbSelect.innerHTML = `<option value="">-- Select Database --</option>`;
                (data.databases || []).forEach(db => {
                    const opt = document.createElement("option");
                    opt.value = db;
                    opt.textContent = db;
                    dbSelect.appendChild(opt);
                });
 
                serverValidated = true;
                lastValidatedServer = serverVal;
                return true;
 
            } catch (err) {
                if (err && err.name === "AbortError") return false;
 
                serverError.textContent = "Server connection failed";
                serverError.style.display = "block";
 
                serverValidated = false;
                lastValidatedServer = "";
 
                dbSelect.innerHTML = `<option value="">-- Select Database --</option>`;
                dbSelect.value = "";
                return false;
 
            } finally {
                if (mySeq === dbFetchSeq) serverValidating = false;
            }
        }
 
        async function blockSelectIfInvalid(e) {
            const ok = await validateServerIfNeeded();
            if (!ok) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById("server").focus();
                return false;
            }
            return true;
        }
 
        dbSelect.addEventListener("focus", blockSelectIfInvalid);
        dbSelect.addEventListener("click", blockSelectIfInvalid);
        dbSelect.addEventListener("keydown", async (e) => {
            if (["Enter", " ", "ArrowDown"].includes(e.key)) {
                await blockSelectIfInvalid(e);
            }
        });
 
        document.getElementById("server").addEventListener("input", () => {
            const serverError = document.getElementById("serverError");
 
            if (dbFetchController) {
                try { dbFetchController.abort(); } catch { }
            }
 
            serverValidated = false;
            lastValidatedServer = "";
 
            dbSelect.innerHTML = `<option value="">-- Select Database --</option>`;
            dbSelect.value = "";
 
            if (!document.getElementById("server").value.trim()) {
                serverError.textContent = "";
                serverError.style.display = "none";
            }
        });
 
        document.getElementById("server").addEventListener("blur", async () => {
            if (document.getElementById("server").value.trim()) {
                await validateServerIfNeeded();
            }
        });
 
        dbSelect.innerHTML = `<option value="">-- Select Database --</option>`;
 
        // ---------- Mode toggle ----------
        document.getElementById("singleRadio").onchange = () => {
            document.getElementById("singleUserBlock").classList.remove("d-none");
            document.getElementById("multiUserBlock").classList.add("d-none");
        };
 
        document.getElementById("multiRadio").onchange = async () => {
            document.getElementById("multiUserBlock").classList.remove("d-none");
            document.getElementById("singleUserBlock").classList.add("d-none");
 
            try {
                const res = await fetch("{{ url_for('userclone.last_saved_bulk_path') }}");
                const data = await res.json();
 
                const tb = document.getElementById("user_file_path");
                const hint = document.getElementById("bulkPathHint");
 
                if (data.success && data.path) {
                    tb.value = data.path;
                    hint.textContent = `Last used: ${data.path}`;
                    hint.style.display = "block";
                } else {
                    tb.value = "";
                    hint.style.display = "none";
                }
            } catch {
                document.getElementById("user_file_path").value = "";
                const hint = document.getElementById("bulkPathHint");
                hint.style.display = "none";
            }
        };
 
        // ---------- Load defaults ----------
        async function loadLoggingDefaults() {
            const res = await fetch("{{ url_for('userclone.logging_defaults') }}");
            const data = await res.json();
            logServer.value = data.server;
            logDB.value = data.database;
 
            await loadRecent();
        }
 
        window.addEventListener("load", loadLoggingDefaults);
 
        // ---------- Streaming output ----------
        const output = document.getElementById("output");
        const progressBar = document.getElementById("progressBar");
        const percentText = document.getElementById("percentText");
        const durationText = document.getElementById("durationText");
 
        function appendOutput(text, isError = false) {
            if (String(text || "").toLowerCase().includes("error")) isError = true;
 
            const span = document.createElement("span");
            span.className = isError ? "output-line output-error" : "output-line";
            span.textContent = text;
 
            output.appendChild(span);
            output.appendChild(document.createElement("br"));
            output.scrollTop = output.scrollHeight;
        }
 
        function setProgress(p) {
            progressBar.style.width = p + "%";
            percentText.textContent = p + "%";
        }
 
        function parseSSEChunk(buf) {
            const events = [];
            const parts = buf.split("\n\n");
            for (let i = 0; i < parts.length - 1; i++) {
                const lines = parts[i].split("\n");
                let ev = { event: null, data: "" };
                for (const L of lines) {
                    if (L.startsWith("event:")) ev.event = L.replace("event:", "").trim();
                    else if (L.startsWith("data:")) ev.data += L.slice(5);
                }
                events.push(ev);
            }
            return { events, remainder: parts[parts.length - 1] };
        }
 
        document.getElementById("submitBtn").onclick = async () => {
            output.textContent = "";
            setProgress(0);
            durationText.textContent = "00:00";
            percentText.textContent = "0%";
 
            if (fileError) { fileError.textContent = ""; fileError.style.display = "none"; }
 
            const serverVal = document.getElementById("server").value.trim();
            const dbVal = document.getElementById("database").value.trim();
 
            if (!serverVal) return;
            if (!dbVal) return;
 
            const fd = new FormData();
            fd.append("server", serverVal);
            fd.append("database", dbVal);
            fd.append("logging_server", logServer.value);
            fd.append("logging_database", logDB.value);
 
            const mode = document.querySelector('input[name="mode"]:checked');
            if (!mode) {
                appendOutput("Mode must be selected");
                return;
            }
            fd.append("mode", mode.value);
 
            if (mode.value === "Single") {
                const oldu = document.getElementById("old_user").value.trim();
                const newu = document.getElementById("new_user").value.trim();
                if (!oldu || !newu) {
                    appendOutput("Both old and new users required");
                    return;
                }
                fd.append("user_pair", `${oldu},${newu}`);
            } else {
                const path = document.getElementById("user_file_path").value.trim();
                if (!path) {
                    if (fileError) {
                        fileError.textContent = "File path required";
                        fileError.style.display = "block";
                    } else {
                        appendOutput("File path required", true);
                    }
                    return;
                }
                fd.append("user_file_path", path);
            }
 
            const res = await fetch("{{ url_for('userclone.run_script_stream') }}", { method: "POST", body: fd });
            if (!res.ok) {
                appendOutput("Server error", true);
                return;
            }
 
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffered = "";
            const start = Date.now();
 
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
 
                buffered += decoder.decode(value, { stream: true });
                const parsed = parseSSEChunk(buffered);
 
                for (const ev of parsed.events) {
                    if (ev.event === "download") {
                        const payload = JSON.parse(ev.data);
                        const a = document.createElement("a");
                        a.href = "data:text/plain;base64," + payload.data;
                        a.download = payload.filename;
                        a.style.display = "none";
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        appendOutput("Download ready: " + payload.filename);
                        continue;
                    }
 
                    if (ev.event === "output") appendOutput(ev.data);
                    if (ev.event === "error") appendOutput(ev.data, true);
 
                    if (ev.event === "progress") {
                        try {
                            const p = JSON.parse(ev.data).percent;
                            setProgress(p);
                        } catch { }
                    }
                    if (ev.event === "done") {
                        try {
                            const d = JSON.parse(ev.data);
                            if (d.duration) durationText.textContent = d.duration + " secs";
                            if (d.error) appendOutput("ERROR: " + d.error, true);
                        } catch { }
                    }
                }
                buffered = parsed.remainder;
            }
 
            if (durationText.textContent === "00:00") {
                const elapsed = Math.floor((Date.now() - start) / 1000);
                durationText.textContent = elapsed + " secs";
            }
 
            await loadRecent();
            await loadLogs();
        };
 
        // ---------- Helpers ----------
        function formatDuration(sec) {
            if (sec === null || sec === undefined) return "";
            sec = Number(sec);
            if (isNaN(sec)) return "";
 
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
 
            if (h > 0) return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
 
        // ‚úÖ IMPORTANT: Recent should say source="recent" not "logs"
        async function loadRecent() {
            const res = await fetch(
                `{{ url_for('userclone.recent_5') }}?log_server=${encodeURIComponent(logServer.value)}&log_db=${encodeURIComponent(logDB.value)}`
            );
            const data = await res.json();
            const tbody = document.getElementById("recentExecBody");
            tbody.innerHTML = "";
 
            (data || []).forEach(r => {
                const tr = document.createElement("tr");
                const err = encodeURIComponent(r.error_message ?? "No error details available");
 
                tr.innerHTML = `
                    <td>${escapeHtml(r.executed_by)}</td>
                    <td>${escapeHtml(r.start_time)}</td>
                    <td>${escapeHtml(r.end_time)}</td>
                    <td>${escapeHtml(formatDuration(r.duration_seconds))}</td>
                    <td>${escapeHtml(r.mode)}</td>
                    <td>
                        ${r.status === "Failed"
                        ? `<span class="status-failed js-open-error"
                                data-source="recent"
                                data-error="${err}"
                                style="cursor:pointer;">
                                Failed
                                <span class="eye-icon js-open-error"
                                    data-source="recent"
                                    data-error="${err}">üëÅ</span>
                           </span>`
                        : escapeHtml(r.status)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
 
        async function loadLogs() {
            const res = await fetch(
                `{{ url_for('userclone.all_logs') }}?log_server=${encodeURIComponent(logServer.value)}&log_db=${encodeURIComponent(logDB.value)}`
            );
            const data = await res.json();
            const tbody = document.getElementById("logsBody");
            tbody.innerHTML = "";
 
            (data || []).forEach(r => {
                const tr = document.createElement("tr");
                const err = encodeURIComponent(r.error_message ?? "No error details available");
 
                tr.innerHTML = `
                    <td>${escapeHtml(r.executed_by)}</td>
                    <td>${escapeHtml(r.start_time)}</td>
                    <td>${escapeHtml(r.end_time)}</td>
                    <td>${escapeHtml(formatDuration(r.duration_seconds))}</td>
                    <td>${escapeHtml(r.mode)}</td>
                    <td>
                        ${r.status === "Failed"
                        ? `<span class="status-failed js-open-error"
                                data-source="logs"
                                data-error="${err}"
                                style="cursor:pointer;">
                                Failed
                                <span class="eye-icon js-open-error"
                                    data-source="logs"
                                    data-error="${err}">üëÅ</span>
                           </span>`
                        : escapeHtml(r.status)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
 
            buildDistinctFilters();
            applyFilters();
        }
 
        // ‚úÖ Single click handler for Failed/üëÅ everywhere (fixes auto-open logs tab)
        document.addEventListener("click", (e) => {
            const el = e.target.closest(".js-open-error");
            if (!el) return;
 
            e.preventDefault();
            e.stopPropagation();
 
            const source = el.getAttribute("data-source") || "recent";
            openErrorModal(el, source);
        });
 
        // ---------- Logs filters ----------
        function buildDistinctFilters() {
            const rows = [...document.querySelectorAll("#logsBody tr")];
 
            const map = [
                "filterExecBy",
                null,
                null,
                null,
                "filterMode",
                "filterStatus"
            ];
 
            for (let col = 0; col < 6; col++) {
                const id = map[col];
                if (!id) continue;
 
                const sel = document.getElementById(id);
                if (!sel || sel.tagName.toLowerCase() !== "select") continue;
 
                const set = new Set();
                rows.forEach(r => {
                    const v = r.children[col].textContent.trim();
                    if (v) set.add(v);
                });
 
                const arr = [...set].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: "base" }));
                sel.innerHTML = `<option value="">All</option>` +
                    arr.map(v => `<option value="${v.toLowerCase()}">${v}</option>`).join("");
            }
        }
 
        function timeMatch(value, f) {
            if (!f) return true;
 
            const dt = new Date(value);
            if (isNaN(dt)) return false;
            const now = new Date();
            const dayMS = 86400000;
 
            if (f === "24h") return now - dt <= 1 * dayMS;
            if (f === "48h") return now - dt <= 2 * dayMS;
            if (f === "7d") return now - dt <= 7 * dayMS;
            if (f === "14d") return now - dt <= 14 * dayMS;
            if (f === "30d") return now - dt <= 30 * dayMS;
 
            if (f === "thisweek") {
                const s = new Date(now);
                s.setDate(now.getDate() - now.getDay());
                s.setHours(0, 0, 0, 0);
                return dt >= s;
            }
            if (f === "thismonth") {
                const s = new Date(now.getFullYear(), now.getMonth(), 1);
                return dt >= s;
            }
            if (f === "thisyear") {
                const s = new Date(now.getFullYear(), 0, 1);
                return dt >= s;
            }
            return true;
        }
 
        function applyFilters() {
            const fExec = document.getElementById("filterExecBy").value.toLowerCase();
            const fStartQuick = document.getElementById("filterStart").value;
            const fMode = document.getElementById("filterMode").value.toLowerCase();
            const fStat = document.getElementById("filterStatus").value.toLowerCase();
 
            const startDateVal = document.getElementById("startDate").value;
            const endDateVal = document.getElementById("endDate").value;
 
            [...document.querySelectorAll("#logsBody tr")].forEach(row => {
                const c = [...row.children].map(td => td.textContent.trim().toLowerCase());
 
                const okExec = !fExec || c[0].includes(fExec);
                const okStartQuick = timeMatch(row.children[1].textContent, fStartQuick);
 
                let okStartCustom = true;
                if (startDateVal || endDateVal) {
                    const dt = new Date(row.children[1].textContent);
                    if (isNaN(dt)) {
                        okStartCustom = false;
                    } else {
                        if (startDateVal) {
                            const sdt = new Date(startDateVal + "T00:00:00");
                            if (dt < sdt) okStartCustom = false;
                        }
                        if (endDateVal) {
                            const edt = new Date(endDateVal + "T23:59:59");
                            if (dt > edt) okStartCustom = false;
                        }
                    }
                }
 
                const okStart = okStartQuick && okStartCustom;
                const okMode = !fMode || c[4].includes(fMode);
                const okStatus = !fStat || c[5].includes(fStat);
 
                row.style.display = (okExec && okStart && okMode && okStatus) ? "" : "none";
            });
        }
 
        document.getElementById("filterExecBy").addEventListener("change", applyFilters);
        document.getElementById("filterStart").addEventListener("change", applyFilters);
        document.getElementById("filterMode").addEventListener("change", applyFilters);
        document.getElementById("filterStatus").addEventListener("change", applyFilters);
 
        const startTimeFilterIcon = document.getElementById("startTimeFilterIcon");
        const startTimeFilterPanel = document.getElementById("startTimeFilterPanel");
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        const applyStartDateFilterBtn = document.getElementById("applyStartDateFilter");
        const clearStartDateFilterBtn = document.getElementById("clearStartDateFilter");
 
        startTimeFilterIcon.onclick = (e) => {
            const rect = e.target.getBoundingClientRect();
            startTimeFilterPanel.style.left = (rect.right + 4) + "px";
            startTimeFilterPanel.style.top = (rect.bottom + 4) + "px";
            startTimeFilterPanel.style.display =
                startTimeFilterPanel.style.display === "block" ? "none" : "block";
        };
 
        applyStartDateFilterBtn.onclick = () => {
            startTimeFilterPanel.style.display = "none";
            applyFilters();
        };
 
        clearStartDateFilterBtn.onclick = () => {
            startDateInput.value = "";
            endDateInput.value = "";
            startTimeFilterPanel.style.display = "none";
            applyFilters();
        };
 
        document.addEventListener("click", (e) => {
            if (!startTimeFilterPanel.contains(e.target) && e.target !== startTimeFilterIcon) {
                startTimeFilterPanel.style.display = "none";
            }
        });
 
        // ---------- Error modal ----------
        function openErrorModal(el, source = "recent") {
            let message = el.getAttribute("data-error") || "No error details available";
            message = decodeURIComponent(message);
 
            errorSource = source;
 
            if (source === "logs") {
                document.getElementById("logsPopup").style.display = "none";
            }
            if (source === "validate") {
                document.getElementById("validatePopup").style.display = "none";
            }
 
            document.getElementById("errorModalBody").textContent = message;
            document.getElementById("errorModal").style.display = "flex";
        }
 
        document.getElementById("errorModalClose").onclick = () => {
            document.getElementById("errorModal").style.display = "none";
 
            // Only reopen if the source was logs/validate. Recent should NOT auto-open anything.
            if (errorSource === "logs") {
                document.getElementById("logsPopup").style.display = "flex";
            }
            if (errorSource === "validate") {
                document.getElementById("validatePopup").style.display = "flex";
            }
 
            errorSource = null;
        };
 
        // ---------- Validate popup ----------
        document.getElementById("validateBtn").onclick = async () => {
            document.getElementById("validatePopup").style.display = "flex";
 
            const tb = document.getElementById("val_file_path");
            const hint = document.getElementById("valPathHint");
            showValPathError("");
 
            try {
                const res = await fetch("{{ url_for('userclone.last_saved_pairs') }}");
                const data = await res.json();
 
                if (data.success && data.source_path) {
                    tb.value = data.source_path;
                    hint.textContent = `Last used: ${data.source_path}`;
                    hint.style.display = "block";
                } else {
                    tb.value = "";
                    hint.style.display = "none";
                }
 
                if (data.success && Array.isArray(data.pairs) && data.pairs.length > 0) {
                    validationPairFilterSet = new Set(
                        data.pairs.map(p => makePairKey(p.old_user, p.new_user))
                    );
                } else {
                    validationPairFilterSet = new Set();
                }
                updateValPairsChip();
 
            } catch {
                tb.value = "";
                hint.style.display = "none";
                validationPairFilterSet = new Set();
                updateValPairsChip();
            }
 
            await loadValidation();
        };
 
        document.getElementById("closeValidatePopup").onclick = () => {
            document.getElementById("validatePopup").style.display = "none";
        };
 
        // ---------- Validation filtering ----------
        let validationPairFilterSet = new Set();
        let validationAllRows = [];
 
        function makePairKey(oldUser, newUser) {
            return `${(oldUser || "").trim().toLowerCase()}|||${(newUser || "").trim().toLowerCase()}`;
        }
 
        function updateValPairsChip() {
            const chip = document.getElementById("valPairsChip");
            const n = validationPairFilterSet.size;
            if (n > 0) {
                chip.style.display = "inline-block";
                chip.textContent = `${n} pairs`;
            } else {
                chip.style.display = "none";
            }
        }
 
        function filterByPairs(rows) {
            if (!validationPairFilterSet || validationPairFilterSet.size === 0) return rows;
            return (rows || []).filter(r => validationPairFilterSet.has(makePairKey(r.old_user, r.new_user)));
        }
 
        function renderValidationRows(rows) {
            const tbody = document.getElementById("validateBody");
            tbody.innerHTML = "";
 
            (rows || []).forEach(r => {
                const tr = document.createElement("tr");
 
                const oldUser = (r.old_user || "").toString();
                const newUser = (r.new_user || "").toString();
                const status = (r.status || "").toString();
                const ts = (r.timestamp || "").toString();
                const remarks = (r.remarks || "").toString();
 
                tr.innerHTML = `
                    <td>${escapeHtml(oldUser)}</td>
                    <td>${escapeHtml(newUser)}</td>
                    <td>${escapeHtml(status)}</td>
                    <td>${escapeHtml(ts)}</td>
                    <td>${escapeHtml(remarks)}</td>
                `;
                tbody.appendChild(tr);
            });
 
            applyValidationFilters();
        }
 
        async function loadValidation() {
            const res = await fetch(
                `{{ url_for('userclone.validation_logs') }}?log_server=${encodeURIComponent(logServer.value)}&log_db=${encodeURIComponent(logDB.value)}`
            );
            const data = await res.json();
 
            validationAllRows = Array.isArray(data) ? data : (data || []);
            const rows = filterByPairs(validationAllRows);
            renderValidationRows(rows);
        }
 
        document.getElementById("applyValPairsBtn").addEventListener("click", async () => {
            const path = document.getElementById("val_file_path").value.trim();
            const hint = document.getElementById("valPathHint");
 
            showValPathError("");
 
            if (!path) {
                showValPathError("File path required");
                return;
            }
 
            const fd = new FormData();
            fd.append("path", path);
 
            const res = await fetch("{{ url_for('userclone.read_pairs_from_path') }}", {
                method: "POST",
                body: fd
            });
 
            const data = await res.json();
 
            if (!data.success) {
                showValPathError(data.message || "Failed to read txt file");
                return;
            }
 
            validationPairFilterSet = new Set(
                (data.pairs || []).map(p => makePairKey(p.old_user, p.new_user))
            );
 
            if (data.saved_path) {
                hint.textContent = `Last used: ${data.saved_path}`;
                hint.style.display = "block";
            }
 
            updateValPairsChip();
            await loadValidation();
        });
 
        document.getElementById("clearValPairsBtn").addEventListener("click", async () => {
            document.getElementById("val_file_path").value = "";
            document.getElementById("valPathHint").style.display = "none";
            showValPathError("");
 
            validationPairFilterSet = new Set();
            updateValPairsChip();
            await loadValidation();
        });
 
        function applyValidationFilters() {
            const fOld = document.getElementById("filterOldUser").value.trim().toLowerCase();
            const fNew = document.getElementById("filterNewUser").value.trim().toLowerCase();
            const fSt = document.getElementById("filterValStatus").value.trim().toLowerCase();
            const fT = document.getElementById("filterValTime").value;
            const fRm = document.getElementById("filterRemarks").value.trim().toLowerCase();
 
            const valStart = document.getElementById("valStartDate").value;
            const valEnd = document.getElementById("valEndDate").value;
 
            [...document.querySelectorAll("#validateBody tr")].forEach(row => {
                const oldUser = row.children[0].textContent.trim().toLowerCase();
                const newUser = row.children[1].textContent.trim().toLowerCase();
                const status = row.children[2].textContent.trim().toLowerCase();
                const ts = row.children[3].textContent.trim();
                const remarks = row.children[4].textContent.trim().toLowerCase();
 
                const okOld = !fOld || oldUser.includes(fOld);
                const okNew = !fNew || newUser.includes(fNew);
                const okSt = !fSt || status.includes(fSt);
                const okQuick = !fT || timeMatch(ts, fT);
                const okRm = !fRm || remarks.includes(fRm);
 
                let okCustom = true;
                if (valStart || valEnd) {
                    const dt = new Date(ts);
                    if (isNaN(dt)) {
                        okCustom = false;
                    } else {
                        if (valStart) {
                            const sdt = new Date(valStart + "T00:00:00");
                            if (dt < sdt) okCustom = false;
                        }
                        if (valEnd) {
                            const edt = new Date(valEnd + "T23:59:59");
                            if (dt > edt) okCustom = false;
                        }
                    }
                }
 
                const okTime = okQuick && okCustom;
                row.style.display = (okOld && okNew && okSt && okTime && okRm) ? "" : "none";
            });
        }
 
        document.getElementById("filterOldUser").addEventListener("input", applyValidationFilters);
        document.getElementById("filterNewUser").addEventListener("input", applyValidationFilters);
        document.getElementById("filterValStatus").addEventListener("change", applyValidationFilters);
        document.getElementById("filterValTime").addEventListener("change", applyValidationFilters);
        document.getElementById("filterRemarks").addEventListener("input", applyValidationFilters);
 
        const valTimeFilterIcon = document.getElementById("valTimeFilterIcon");
        const valTimeFilterPanel = document.getElementById("valTimeFilterPanel");
        const valStartDateInput = document.getElementById("valStartDate");
        const valEndDateInput = document.getElementById("valEndDate");
        const applyValDateFilterBtn = document.getElementById("applyValDateFilter");
        const clearValDateFilterBtn = document.getElementById("clearValDateFilter");
 
        valTimeFilterIcon.onclick = (e) => {
            const rect = e.target.getBoundingClientRect();
            valTimeFilterPanel.style.left = (rect.right + 4) + "px";
            valTimeFilterPanel.style.top = (rect.bottom + 4) + "px";
            valTimeFilterPanel.style.display =
                valTimeFilterPanel.style.display === "block" ? "none" : "block";
        };
 
        applyValDateFilterBtn.onclick = () => {
            valTimeFilterPanel.style.display = "none";
            applyValidationFilters();
        };
 
        clearValDateFilterBtn.onclick = () => {
            valStartDateInput.value = "";
            valEndDateInput.value = "";
            valTimeFilterPanel.style.display = "none";
            applyValidationFilters();
        };
 
        document.addEventListener("click", (e) => {
            if (!valTimeFilterPanel.contains(e.target) && e.target !== valTimeFilterIcon) {
                valTimeFilterPanel.style.display = "none";
            }
        });
 
        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }
    </script>
 
</body>
 
</html>
 
 
 