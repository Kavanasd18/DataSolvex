<!DOCTYPE html>
<html lang="en">
 
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create SQL Login | DataSolveX</title>
  <link rel="stylesheet" href="../static/global.css">
  <link rel="stylesheet" href="../static/replication.css">
 
  <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
 
  <style>
    /* Sticky footer base layout */
 
    html,
    body {
 
      height: 100%;
 
    }
 
    body {
 
      margin: 0;
 
      min-height: 100vh;
 
      display: flex;
 
      flex-direction: column;
 
    }
 
    /* Your page content wrapper must grow */
 
    .page-wrapper,
    main {
 
      flex: 1;
 
    }
 
    /* Footer sticks to bottom */
 
    .site-footer {
 
      margin-top: auto;
 
      padding: 12px 24px;
 
      border-top: 1px solid rgba(148, 163, 184, 0.4);
 
      background: #f3f4f6;
 
      color: #4b5563;
 
      font-size: 13px;
 
    }
  </style>
</head>
 
<main>
 
  <body>
    <header class="app-header">
      <!-- Top Navigation Bar -->
      <nav class="app-nav">
        <div class="app-nav-container">
          <a href="{{ url_for('index') }}" class="app-brand">DataSolveX</a>
 
        </div>
      </nav>
 
      <!-- Breadcrumb Bar -->
      <div class="app-breadcrumb">
        <div class="app-breadcrumb-container">
          <ul class="breadcrumb-list">
            <!-- Update these items for each page -->
            <li class="breadcrumb-item">
              <a href="{{ url_for('index') }}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Home
              </a>
            </li>
            <li class="breadcrumb-item">
              <a href="{{ url_for('sqlserver_main') }}">Microsoft SQL Server</a>
            </li>
            <li class="breadcrumb-item active">Login Creation</li>
          </ul>
        </div>
      </div>
    </header>
 
    <div class="page-wrapper">
      <!-- Form Page Container -->
      <div class="form-page-container">
        <div class="form-panel">
 
          <!-- Form Panel Header -->
          <div class="form-panel-header">
            <div class="panel-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
            </div>
            <h2>Login Configuration</h2>
          </div>
 
          <!-- Form Panel Body -->
          <div class="form-panel-body">
            <form id="create-login-form">
 
              <!-- Server & Database Section -->
              <div class="form-section">
                <h3 class="form-section-title">Server Configuration</h3>
                <div class="row">
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Server Name <span class="required">*</span></label>
                      <input type="text" id="server_name" name="server_name" placeholder="Enter server name" required />
                      <span class="form-help">The SQL Server instance to connect to</span>
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Target Database <span class="required">*</span></label>
                      <select id="database_name" name="database_name" required>
                        <option value="">-- Select a database --</option>
                      </select>
                      <span class="form-help">Database where the login will be created</span>
                    </div>
                  </div>
                </div>
              </div>
 
              <!-- Login Details Section -->
              <div class="form-section">
                <h3 class="form-section-title">Login Details</h3>
                <div class="row">
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Login Name <span class="required">*</span></label>
                      <input type="text" id="login_name" name="login_name" placeholder="Enter login name" required />
                      <div id="login-exists-message" class="alert alert-warning mt-2" style="display: none;">
                        <span class="alert-icon">⚠</span>
                        <div class="alert-content">This login already exists on the server.</div>
                      </div>
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">User Name</label>
                      <input type="text" id="user_name" name="user_name" placeholder="Auto-populated from login name"
                        readonly />
                      <span class="form-help">Automatically synced with Login Name</span>
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Request ID <span class="required">*</span></label>
                      <input type="text" id="request_id" name="request_id" placeholder="e.g., REQ-2024-001" required />
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Application <span class="required">*</span></label>
                      <select id="application" name="application" required>
                        <option value="">--Select Application--</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
 
              <!-- Classification Section -->
              <div class="form-section">
                <h3 class="form-section-title">Classification</h3>
                <div class="row">
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Environment <span class="required">*</span></label>
                      <select id="environment" name="environment" required>
                        <option value="">-- Select Environment --</option>
                        <option value="Dev">Development</option>
                        <option value="Test">Test</option>
                        <option value="Prod">Production</option>
                        <option value="IFT">IFT</option>
                        <option value="SVT">SVT</option>
                      </select>
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Product <span class="required">*</span></label>
                      <select id="product" name="product" required>
                        <option value="">-- Select Product --</option>
 
                        <optgroup label="Non-Production" data-env="nonprod">
                          <option value="NON PRD sql id">NON PRD SQL ID</option>
                          <option value="NON PRD service account">NON PRD Service Account</option>
                          <option value="NON PRD NT ID">NON PRD NT ID</option>
                          <option value="NON PRD GMSA service account">NON PRD GMSA Service Account</option>
                          <option value="NON PRD user DL">NON PRD User DL</option>
                        </optgroup>
 
                        <optgroup label="Production" data-env="prod">
                          <option value="PRD SQL ID">PRD SQL ID</option>
                          <option value="PRD service account">PRD Service Account</option>
                          <option value="PRD NT ID">PRD NT ID</option>
                          <option value="PRD GMSA service account">PRD GMSA Service Account</option>
                        </optgroup>
 
                        <optgroup label="Other" data-env="other">
                          <option value="EPM unit account">EPM Unit Account</option>
                        </optgroup>
                      </select>
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Type <span class="required">*</span></label>
                      <select id="type" name="type" required>
                        <option value="">-- Select Type --</option>
                        <optgroup label="Linked Server">
                          <option value="Linked Server">Linked Server</option>
                          <option value="Internal Linked server">Internal Linked Server</option>
                        </optgroup>
                        <optgroup label="Service Accounts">
                          <option value="SA account">SA Account</option>
                          <option value="non PRD service account">Non PRD Service Account</option>
                          <option value="PRD service account">PRD Service Account</option>
                          <option value="non prd gsma service account">Non PRD GMSA Service Account</option>
                          <option value="PRD GMSA service account">PRD GMSA Service Account</option>
                        </optgroup>
                        <optgroup label="User Accounts">
                          <option value="NT user">NT User</option>
                          <option value="SQL ID">SQL ID</option>
                          <option value="SAP ID">SAP ID</option>
                          <option value="db id">DB ID</option>
                        </optgroup>
                        <optgroup label="Group & Team">
                          <option value="Group account">Group Account</option>
                          <option value="EPM unit">EPM Unit</option>
                          <option value="external DL">External DL</option>
                          <option value="application team">Application Team</option>
                        </optgroup>
                        <optgroup label="Automation">
                          <option value="control m account">Control M Account</option>
                          <option value="non prd scripter account">Non PRD Scripter Account</option>
                          <option value="PRD scripter account">PRD Scripter Account</option>
                          <option value="PRD batch job account">PRD Batch Job Account</option>
                        </optgroup>
                        <optgroup label="eQuest">
                          <option value="Equest">eQuest</option>
                          <option value="PRD equest service account">PRD eQuest Service Account</option>
                          <option value="non prd equest service account">Non PRD eQuest Service Account</option>
                          <option value="Disabled,equest">Disabled eQuest</option>
                        </optgroup>
                        <optgroup label="Configuration">
                          <option value="CFG_Exception">CFG Exception</option>
                          <option value="CFG_ID">CFG ID</option>
                          <option value="schema">Schema</option>
                        </optgroup>
                        <optgroup label="Other">
                          <option value="non prd SRA app account">Non PRD SRA App Account</option>
                          <option value="Disabled">Disabled</option>
                        </optgroup>
                      </select>
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Ownership <span class="required">*</span></label>
                      <select id="ownership" name="ownership" required>
                        <option value="">-- Select Ownership --</option>
                        <optgroup label="Database Teams">
                          <option value="db team">DB Team</option>
                          <option value="CFG Team">CFG Team</option>
                        </optgroup>
                        <optgroup label="Support Teams">
                          <option value="L1 team">L1 Team</option>
                          <option value="IS unit">IS Unit</option>
                        </optgroup>
                        <optgroup label="Automation">
                          <option value="control m team">Control M Team</option>
                          <option value="scripter team">Scripter Team</option>
                        </optgroup>
                        <optgroup label="Application Teams">
                          <option value="SRA team">SRA Team</option>
                          <option value="eQuest team">eQuest Team</option>
                          <option value="SAP team">SAP Team</option>
                        </optgroup>
                        <optgroup label="Other">
                          <option value="NT USER">NT User</option>
                          <option value="GMSA account">GMSA Account</option>
                          <option value="quality team">Quality Team</option>
                          <option value="security team">Security Team</option>
                        </optgroup>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
 
              <!-- Contact Information Section -->
              <div class="form-section">
                <h3 class="form-section-title">Contact Information</h3>
                <div class="row">
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">Owner Contact </label>
                      <input type="text" id="owner_contact" name="owner_contact" placeholder="Email or name" />
                    </div>
                  </div>
 
                  <div class="col-6">
                    <div class="form-group">
                      <label class="form-label">POC (PM for Application) </label>
                      <select id="poc_select" name="poc_select">
                        <option value="">--Select POC--</option>
                      </select>
 
                      <input type="text" id="poc_manual" name="poc_manual" placeholder="Enter POC"
                        style="display:none; margin-top:6px;" />
                    </div>
                  </div>
 
                  <div class="col-12">
                    <div class="form-group">
                      <label class="form-label">ID Information <span class="required">*</span></label>
                      <input type="text" id="reason" name="reason" required
                        placeholder="Reason for creating this login (e.g., New application deployment, Access request #12345)" />
                      <span class="form-help">Provide a brief description of why this login is being created</span>
                    </div>
                  </div>
                </div>
              </div>
            </form>
 
            <!-- Message Display -->
            <div id="message" class="alert mt-4" style="display: none;"></div>
 
            <!-- Login Details Display -->
            <div id="login-details" class="card-bordered mt-4" style="display: none;">
              <div class="card-body"></div>
            </div>
          </div>
 
          <!-- Form Panel Footer with Action Buttons -->
          <div class="form-panel-footer">
            <button type="reset" form="create-login-form" class="btn-action-secondary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
              </svg>
              Reset Form
            </button>
            <button type="submit" form="create-login-form" class="btn-action-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
              </svg>
              Create Login
            </button>
          </div>
 
        </div>
      </div>
    </div>
</main>
 
<footer class="footer">
  <div style="display:flex; justify-content:center; align-items:center; gap:12px; flex-wrap:wrap;">
    <div class="footer-bottom">
      DataSolveX
    </div>
  </div>
</footer>
 
 
 
<script>
  $('#server_name').on('change', function () {
    let serverName = $(this).val();
    if (serverName) {
      $.ajax({
        url: '/fetch_databases',
        method: 'POST',
        data: { server: serverName },
        success: function (response) {
          $('#database_name').empty();
          $('#database_name').append('<option value="">Select a database</option>');
          $.each(response.databases, function (index, dbName) {
            $('#database_name').append('<option value="' + dbName + '">' + dbName + '</option>');
          });
        }
      });
    }
  });
 
  $('#login_name').on('blur', function () {
    let loginName = $(this).val();
    let serverName = $('#server_name').val();
    if (loginName && serverName) {
      $.ajax({
        url: '/check-login-exists',
        method: 'POST',
        data: { login_name: loginName, server_name: serverName },
        success: function (response) {
          if (response.exists) {
            $('#login-exists-message').show();
          } else {
            $('#login-exists-message').hide();
          }
        }
      });
    }
  });
 
  $('#login_name').on('input', function () {
    let loginName = $(this).val();
    $('#user_name').val(loginName);
  });
 
  $('#create-login-form').on('submit', function (e) {
    e.preventDefault();
    $.ajax({
      url: '/create-login',
      method: 'POST',
      data: $(this).serialize(),
      success: function (response) {
        let messageDiv = $('#message');
        let detailsDiv = $('#login-details');
        messageDiv.show();
 
        if (response.message) {
          messageDiv.removeClass('alert-error').addClass('alert alert-success').html('<span class="alert-icon">✔️</span><div class="alert-content">' + response.message + '</div>');
          detailsDiv.find('.card-body').html('<strong>Login Name:</strong> ' + response.login_name);
          if (response.powershell_output) {
            detailsDiv.find('.card-body').append('<br><strong>PowerShell Output:</strong> <pre style="background: var(--dark); color: var(--light-cyan); padding: 15px; border-radius: var(--radius-sm); overflow-x: auto; margin-top: 10px;">' + response.powershell_output + '</pre>');
          }
          detailsDiv.show();
        } else if (response.error) {
          messageDiv.removeClass('alert-success').addClass('alert alert-error').html('<span class="alert-icon">❌</span><div class="alert-content">' + response.error + '</div>');
          detailsDiv.hide();
        }
      }
    });
  });
</script>
 
<script>
 
  function loadPOCs(applicationName) {
 
    const pocSelect = $('#poc_select');
 
    const pocManual = $('#poc_manual');
 
    const pocHelper = $('#poc_helper');
 
    // Reset both
 
    pocSelect.empty();
 
    pocSelect.append('<option value="">-- Select POC --</option>');
 
    pocManual.val('');
 
    if (!applicationName || applicationName.trim() === '') {
 
      // No application → show dropdown empty, hide textbox
 
      pocSelect.show();
 
      pocManual.hide();
 
      pocHelper.text('POCs will be loaded based on Application. If none found, you can type manually.');
 
      return;
 
    }
 
    $.ajax({
 
      url: '/get-pocs',
 
      method: 'GET',
 
      data: { application: applicationName },
 
      success: function (response) {
 
        // If we have POCs → use dropdown
 
        if (response.pocs && response.pocs.length > 0) {
 
          pocSelect.empty();
 
          pocSelect.append('<option value="">-- Select POC --</option>');
 
          $.each(response.pocs, function (index, pocName) {
 
            pocSelect.append(
 
              '<option value="' + pocName + '">' + pocName + '</option>'
 
            );
 
          });
 
          // Show dropdown, hide textbox
 
          pocSelect.show();
 
          pocManual.hide();
 
          pocHelper.text('Select a POC for the chosen application.');
 
        } else {
 
          // No POCs → hide dropdown, show textbox
 
          pocSelect.hide();
 
          pocManual.show();
 
          pocHelper.text('No POC found for this application. Enter POC manually.');
 
        }
 
      },
 
      error: function () {
 
        console.error('Failed to load POC list');
 
        // On error, allow manual entry
 
        pocSelect.hide();
 
        pocManual.show();
 
        pocHelper.text('Error loading POCs. Enter POC manually.');
 
      }
 
    });
 
  }
 
  let pocLoadTimeout = null;
 
  $(document).ready(function () {
 
    $('#application').on('input', function () {
 
      const appName = $(this).val();
 
      clearTimeout(pocLoadTimeout);
 
      pocLoadTimeout = setTimeout(function () {
 
        loadPOCs(appName);
 
      }, 400);
 
    });
 
  });
</script>
 
 
 
 
 
<script>
  window.addEventListener('beforeunload', function () {
    const data = JSON.stringify({
      page: window.location.pathname,
      timestamp: new Date().toISOString()
    });
    const blob = new Blob([data], { type: 'application/json' });
    navigator.sendBeacon('/log-exit', blob);
  });
</script>
 
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const now = new Date().toISOString();
    const page = window.location.pathname;
    fetch('/log-entry', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ page: page, timestamp: now })
    });
  });
</script>
 
<script>
 
  function loadApplications() {
 
    $.ajax({
 
      url: '/get-applications',
 
      method: 'GET',
 
      success: function (response) {
 
        // For debugging – see what backend returns
 
        console.log('get-applications response:', response);
 
        const appSelect = $('#application');
 
        appSelect.empty();
 
        appSelect.append('<option value="">-- Select Application --</option>');
 
        if (response.applications && response.applications.length > 0) {
 
          $.each(response.applications, function (index, appName) {
 
            appSelect.append(
 
              '<option value="' + appName + '">' + appName + '</option>'
 
            );
 
          });
 
        } else {
 
          appSelect.append('<option value="">No applications found</option>');
 
        }
 
      },
 
      error: function (xhr, status, error) {
 
        console.error('Failed to load applications:', status, error);
 
      }
 
    });
 
  }
 
  $(document).ready(function () {
 
    console.log('Document ready → loading applications');
 
    loadApplications();
 
    // Optional: just to see what user picked
 
    $('#application').on('change', function () {
 
      console.log('Selected application:', $(this).val());
 
    });
 
  });
</script>
 
<script>
  (function () {
    const envSelect = document.getElementById("environment");
    const productSelect = document.getElementById("product");
 
    const defaultOption = productSelect.querySelector('option[value=""]');
    const groups = Array.from(productSelect.querySelectorAll("optgroup"));
 
    function renderProductsForEnv(env) {
      // reset selected product whenever env changes
      productSelect.value = "";
 
      // clear dropdown and keep only default option
      productSelect.innerHTML = "";
      productSelect.appendChild(defaultOption);
 
      // no env selected => keep empty (only default)
      if (!env) return;
 
      const isNonProdEnv = (env === "Dev" || env === "Test" || env === "IFT" || env === "SVT");
      const isProdEnv = (env === "Prod");
 
      groups.forEach(g => {
        const tag = g.getAttribute("data-env"); // nonprod | prod | other
 
        // YOUR EXACT RULES:
        // Dev/Test => show nonprod + other
        // Prod => show prod only
        const allowed =
          (isNonProdEnv && (tag === "nonprod" || tag === "other")) ||
          (isProdEnv && tag === "prod");
 
        if (allowed) productSelect.appendChild(g);
      });
    }
 
    envSelect.addEventListener("change", () => renderProductsForEnv(envSelect.value));
    document.addEventListener("DOMContentLoaded", () => renderProductsForEnv(envSelect.value));
  })();
</script>
 
<script src="/static/js/page_exit_beacon.js" defer ></script>
 
</body>
 
</html>
 