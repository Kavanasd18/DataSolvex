<!DOCTYPE html>
<html lang="en">
 
<head>
  <meta charset="UTF-8" />
  <title>
    {{ db.database_name }} – Object Inventory | {{ server.name }}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 
  <!-- Bootstrap ONLY for btn classes you already use (btn btn-sm etc.). Doesn't change logic. -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
 
  <!-- REQUIRED for html-query-plan rendering (you removed these earlier -> things looked "gone") -->
  <link rel="stylesheet" href="{{ url_for('static', filename='html-query-plan/qp.css') }}" />
  <script src="{{ url_for('static', filename='html-query-plan/qp.min.js') }}"></script>
 
  <style>
    :root {
      --bg-grad-start: #e0f2fe;
      --bg-grad-mid: #eef2ff;
      --bg-grad-end: #f9fafb;
      --card-bg: #ffffff;
      --border-subtle: rgba(148, 163, 184, 0.4);
      --border-strong: rgba(15, 23, 42, 0.08);
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
 
      /* DSX header/footer colors */
      --dsx-blue: #003a78;
      --dsx-blue-dark: #001f4d;
      --dsx-white: #ffffff;
    }
 
    * {
      box-sizing: border-box;
    }
 
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top,
          var(--bg-grad-start) 0,
          var(--bg-grad-mid) 28%,
          var(--bg-grad-end) 100%);
      color: var(--text-main);
 
      /* footer stick bottom */
      display: flex;
      flex-direction: column;
    }
 
    a {
      color: var(--accent);
      text-decoration: none;
    }
 
    a:hover {
      text-decoration: underline;
    }
 
    /* =========================
       DSX HEADER + FOOTER (NEW)
       ========================= */
 
    .dsx-header {
      position: sticky;
      top: 0;
      z-index: 2000;
      width: 100%;
    }
 
    .dsx-topbar {
      background: var(--dsx-white);
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
    }
 
    .dsx-topbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 14px;
 
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
    }
 
    .dsx-brand {
      font-size: 22px;
      font-weight: 800;
      color: #0b2a6f;
      letter-spacing: 0.2px;
      line-height: 1;
    }
 
    .dsx-crumbbar {
      background: var(--dsx-blue);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
    }
 
    .dsx-crumbbar-inner {
      max-width: 1200px;
      margin: 0 auto;
 
      /* move text more left: reduce padding-left */
      padding: 10px 8px;
 
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
 
    .dsx-crumbs {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.92);
    }
 
    .dsx-crumbs a {
      color: rgba(255, 255, 255, 0.92);
      text-decoration: none;
      font-weight: 600;
    }
 
    .dsx-crumbs a:hover {
      text-decoration: underline;
    }
 
    .dsx-sep {
      opacity: 0.75;
    }
 
    .dsx-right-title {
      color: rgba(255, 255, 255, 0.95);
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
    }
 
    .dsx-footer {
      width: 100%;
      background: linear-gradient(180deg, var(--dsx-blue) 0%, var(--dsx-blue-dark) 100%);
      color: rgba(255, 255, 255, 0.85);
      flex-shrink: 0;
    }
 
    .dsx-footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 14px;
      text-align: center;
      font-size: 14px;
    }
 
    /* =========================
       ORIGINAL PAGE CSS (UNCHANGED)
       ========================= */
 
    .page-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 14px 36px;
      width: 100%;
      flex: 1 0 auto;
    }
 
    .page-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1rem;
    }
 
    .breadcrumb-text {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
 
    .page-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
 
    .page-title {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: baseline;
    }
 
    .page-title span.db-name {
      color: var(--accent);
    }
 
    .page-subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
 
    .back-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
 
    .back-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
    }
 
    .back-chip span.icon {
      font-size: 0.9rem;
    }
 
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
      padding: 16px 18px;
      margin-bottom: 16px;
    }
 
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }
 
    .summary-tile {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.96),
          rgba(248, 250, 252, 0.98));
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
 
    .summary-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
 
    .summary-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
    }
 
    .summary-subtext {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
 
    .filters-card {
      margin-top: 6px;
    }
 
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-start;
    }
 
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 220px;
    }
 
    .filter-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
    }
 
    .filter-select,
    .filter-button,
    .download-button {
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0 12px;
      font-size: 0.85rem;
      outline: none;
      background: #ffffff;
      color: var(--text-main);
    }
 
    .filter-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }
 
    .filter-button {
      background: var(--accent);
      color: #ffffff;
      border-color: var(--accent);
      cursor: pointer;
      white-space: nowrap;
    }
 
    .filter-button:hover {
      background: #1d4ed8;
    }
 
    .download-button {
      background: var(--accent-soft);
      border-color: rgba(37, 99, 235, 0.4);
      color: #1d4ed8;
      cursor: pointer;
      white-space: nowrap;
    }
 
    .filters-actions {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      justify-content: flex-start;
    }
 
    .filters-hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }
 
    .flow-card {
      padding: 12px 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
 
    .flow-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-right: 6px;
    }
 
    .flow-trail {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
 
    .flow-node {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(219, 234, 254, 0.65);
      border: 1px solid rgba(37, 99, 235, 0.25);
      font-size: 0.85rem;
      font-weight: 600;
      color: #1d4ed8;
      line-height: 1;
    }
 
    .flow-node .flow-type {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: rgba(29, 78, 216, 0.85);
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(37, 99, 235, 0.25);
      padding: 2px 6px;
      border-radius: 999px;
    }
 
    .flow-sep {
      color: var(--text-muted);
      font-weight: 700;
      user-select: none;
    }
 
    .multi-select-group {
      flex: 1 1 260px;
    }
 
    .multi-select-wrapper {
      position: relative;
      width: 100%;
    }
 
    .multi-select-toggle {
      width: 100%;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0 12px;
      font-size: 0.85rem;
      background: #ffffff;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
 
    .multi-select-toggle:hover {
      border-color: var(--accent);
    }
 
    .multi-select-toggle .caret {
      font-size: 0.7rem;
      margin-left: 8px;
    }
 
    .multi-select-dropdown {
      margin-top: 4px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      padding: 6px 8px;
      display: none;
      max-height: 260px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
      z-index: 5000; /* important: above header + cards */
      position: absolute;
      left: 0;
      right: 0;
    }
 
    .multi-select-dropdown.open {
      display: block;
    }
 
    .objects-search-input {
      width: 100%;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0 10px;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }
 
    .objects-search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }
 
    .multi-select-box {
      width: 100%;
      max-height: 190px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      padding: 4px 6px;
      overflow-y: auto;
    }
 
    .multi-select-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 2px 4px;
      font-size: 0.82rem;
      color: var(--text-main);
      cursor: pointer;
    }
 
    .multi-select-item input[type="checkbox"] {
      margin: 0;
    }
 
    .detail-card {
      margin-top: 10px;
    }
 
    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #111827;
    }
 
    .object-meta-section {
      margin-top: 4px;
    }
 
    .object-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
    }
 
    .object-meta-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
 
    .object-meta-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
 
    .object-meta-value {
      font-size: 0.9rem;
      color: var(--text-main);
      font-weight: 500;
      word-break: break-word;
      overflow-wrap: break-word;
    }
 
    .object-meta-value.mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
    }
 
    .object-extra-section {
      margin-top: 1.25rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
    }
 
    .object-extra-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      max-height: 260px;
    }
 
    .object-extra-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 6px;
    }
 
    .object-extra-scroll {
      flex: 1;
      overflow: auto;
    }
 
    .object-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
 
    .object-table thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }
 
    .object-table th,
    .object-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      text-align: left;
      vertical-align: top;
    }
 
    .object-table th {
      font-weight: 600;
      color: #6b7280;
    }
 
    .object-table tr:last-child td {
      border-bottom: none;
    }
 
    .object-deps-section {
      margin-top: 1.4rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
    }
 
    .object-deps-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      max-height: 260px;
    }
 
    .object-deps-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 6px;
    }
 
    .object-deps-list {
      font-size: 0.85rem;
      color: var(--text-main);
      overflow-y: auto;
      padding-right: 4px;
    }
 
    .object-deps-item {
      padding: 4px 0;
      border-bottom: 1px dashed rgba(148, 163, 184, 0.45);
    }
 
    .object-deps-item:last-child {
      border-bottom: none;
    }
 
    .object-deps-name {
      font-weight: 600;
    }
 
    .object-deps-type {
      font-size: 0.78rem;
      color: var(--text-muted);
    }
 
    .no-selection {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }
 
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: #e5e7eb;
      color: #374151;
      margin-left: 6px;
    }
 
    .pill-type-table {
      background: #dcfce7;
      color: #166534;
    }
 
    .pill-type-view {
      background: #e0f2fe;
      color: #1d4ed8;
    }
 
    .pill-type-proc {
      background: #fee2e2;
      color: #b91c1c;
    }
 
    .pill-type-func {
      background: #fef3c7;
      color: #92400e;
    }
 
    .object-block-separator {
      margin: 1.2rem 0 0.8rem;
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
    }
 
    @media (max-width: 640px) {
      .page-header {
        align-items: flex-start;
      }
    }
  </style>
</head>
 
<body>
 
  <!-- ===== DSX HEADER ===== -->
  <header class="dsx-header">
    <div class="dsx-topbar">
      <div class="dsx-topbar-inner">
        <div class="dsx-brand">DataSolveX</div>
      </div>
    </div>
 
    <div class="dsx-crumbbar">
      <div class="dsx-crumbbar-inner">
        <nav class="dsx-crumbs" aria-label="breadcrumb">
          <a href="/sqlserver_main">SQL Server Main</a>
          <span class="dsx-sep">›</span>
          <a href="/inventory-mgmt/">Inventory Management</a>
          <span class="dsx-sep">›</span>
          <a href="{{ url_for('server_detail', server_id=server.id) }}">{{ server.name }}</a>
          <span class="dsx-sep">›</span>
          <a href="{{ url_for('db_detail', server_id=server.id, db_name=db.database_name) }}">{{ db.database_name }}</a>
          <span class="dsx-sep">›</span>
          <span style="font-weight:700;">Objects</span>
        </nav>
 
      </div>
    </div>
  </header>
  <!-- ===== /DSX HEADER ===== -->
 
  <div class="page-shell">
 
    <!-- Summary tiles -->
    <div class="card">
      <div class="summary-grid">
        <div class="summary-tile">
          <div class="summary-label">Tables</div>
          <div class="summary-value">
            {{ obj_summary.tables if obj_summary and obj_summary.tables is not none else 0 }}
          </div>
        </div>
 
        <div class="summary-tile">
          <div class="summary-label">Views</div>
          <div class="summary-value">
            {{ obj_summary.views if obj_summary and obj_summary.views is not none else 0 }}
          </div>
        </div>
 
        <div class="summary-tile">
          <div class="summary-label">Stored procedures</div>
          <div class="summary-value">
            {{ obj_summary.procedures if obj_summary and obj_summary.procedures is not none else 0 }}
          </div>
        </div>
 
        <div class="summary-tile">
          <div class="summary-label">Functions</div>
          <div class="summary-value">
            {{ obj_summary.functions if obj_summary and obj_summary.functions is not none else 0 }}
          </div>
        </div>
 
        <div class="summary-tile">
          <div class="summary-label">Table-level triggers</div>
          <div class="summary-value">
            {{ obj_summary.table_triggers or 0 }}
          </div>
        </div>
 
        {% if obj_summary and obj_summary.largest_table_name %}
        <div class="summary-tile">
          <div class="summary-label">Largest table</div>
          <div class="summary-value">
            {{ obj_summary.largest_table_name }}
          </div>
          <div class="summary-subtext">
            Approx size:
            {{ "%.2f" | format(obj_summary.largest_table_mb or 0) }} MB
          </div>
        </div>
        {% endif %}
      </div>
    </div>
 
    <!-- Filters -->
    <div class="card filters-card">
      <form method="get" action="{{ url_for('db_objects', server_id=server.id, db_name=db.database_name) }}">
        <div class="filters-row">
 
          <!-- Object type dropdown -->
          <div class="filter-group">
            <label class="filter-label" for="type-select">Object type</label>
            <select id="type-select" name="type" class="filter-select">
              <option value="table" {% if selected_type=='TABLE' %}selected{% endif %}>Tables</option>
              <option value="view" {% if selected_type=='VIEW' %}selected{% endif %}>Views</option>
              <option value="procedure" {% if selected_type=='PROCEDURE' %}selected{% endif %}>
                Stored procedures
              </option>
              <option value="function" {% if selected_type=='FUNCTION' %}selected{% endif %}>
                Functions
              </option>
            </select>
          </div>
 
          <!-- Objects multi-select -->
          <div class="filter-group multi-select-group">
            <label class="filter-label">Objects</label>
 
            <div class="multi-select-wrapper">
              <button type="button" id="objects-toggle" class="multi-select-toggle">
                <span id="objects-toggle-label">Select objects...</span>
                <span class="caret">▾</span>
              </button>
 
              <div class="multi-select-dropdown" id="objects-dropdown">
                <input type="text" id="objects-search" class="objects-search-input" placeholder="Search objects..."
                  autocomplete="off" />
 
                <div class="multi-select-box" id="objects-container">
                  <!-- Filled by JS -->
                </div>
              </div>
            </div>
 
            <div class="filters-hint">
              Pick one or more objects, then click <strong>View object(s)</strong>.
            </div>
          </div>
 
          <!-- Actions -->
          <div class="filters-actions">
            <button type="submit" class="filter-button">
              View object(s)
            </button>
 
            <button type="submit" class="download-button" id="download-btn"
              formaction="{{ url_for('download_objects_multi', server_id=server.id, db_name=db.database_name) }}"
              formmethod="get">
              ⬇ Download CSV
            </button>
          </div>
 
        </div>
      </form>
    </div>
 
    <!-- Dependency flow -->
    {% if trail_links and selected_objects and selected_objects|length == 1 %}
    <div class="card flow-card">
      <div class="flow-label">Flow</div>
      <div class="flow-trail">
        {% for step in trail_links %}
        <a class="flow-node" href="{{ url_for('db_objects',
            server_id=server.id,
            db_name=db.database_name,
            type=step.type_q,
            names=step.name,
            trail=step.trail) }}">
          <span class="flow-type">{{ step.type_q }}</span>
          <span class="flow-name">{{ step.name }}</span>
        </a>
        {% if not loop.last %}
        <span class="flow-sep">&gt;</span>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}
 
    <!-- Object details -->
    <div class="card detail-card">
      {% if not selected_objects %}
      <div class="no-selection">
        No object selected yet. Choose an object type, pick one or more objects, then click
        <strong>View object(s)</strong>.
      </div>
      {% else %}
      {% for obj in selected_objects %}
      {% set object_meta = obj.meta %}
      {% set obj_type = obj.type %}
 
      {% if not object_meta %}
      <div class="no-selection">
        No metadata found for "<strong>{{ obj.name }}</strong>". The object may have been dropped.
      </div>
      {% else %}
      {% if not loop.first %}
      <div class="object-block-separator"></div>
      {% endif %}
 
      <!-- 1. Object metadata -->
      <section class="object-meta-section">
        <h3 class="section-title">
          Object metadata – <span class="mono">{{ object_meta.full_name }}</span>
          {% if obj_type == 'TABLE' %}
          <span class="pill pill-type-table">Table</span>
          {% elif obj_type == 'VIEW' %}
          <span class="pill pill-type-view">View</span>
          {% elif obj_type == 'PROCEDURE' %}
          <span class="pill pill-type-proc">Stored procedure</span>
          {% elif obj_type == 'FUNCTION' %}
          <span class="pill pill-type-func">Function</span>
          {% endif %}
        </h3>
 
        <div class="object-meta-grid">
          <div class="object-meta-card">
            <div class="object-meta-label">Full name</div>
            <div class="object-meta-value mono">{{ object_meta.full_name }}</div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Type</div>
            <div class="object-meta-value">{{ object_meta.type_desc }}</div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Created</div>
            <div class="object-meta-value">{{ object_meta.create_date }}</div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Last modified</div>
            <div class="object-meta-value">{{ object_meta.modify_date }}</div>
          </div>
 
          {% if obj_type == 'TABLE' %}
          <div class="object-meta-card">
            <div class="object-meta-label">Row count</div>
            <div class="object-meta-value">
              {{ object_meta.extras.row_count or 0 }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Used size (MB)</div>
            <div class="object-meta-value">
              {{ object_meta.extras.used_mb or 0 }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Reserved size (MB)</div>
            <div class="object-meta-value">
              {{ object_meta.extras.reserved_mb or 0 }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Index count</div>
            <div class="object-meta-value">
              {{ object_meta.extras.index_count or 0 }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Partitioned</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.is_partitioned else 'No' }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Partition key</div>
            <div class="object-meta-value">
              {{ object_meta.extras.partition_key or 'N/A' }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Partition scheme</div>
            <div class="object-meta-value">
              {{ object_meta.extras.partition_scheme or 'N/A' }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Partition function</div>
            <div class="object-meta-value">
              {{ object_meta.extras.partition_function or 'N/A' }}
            </div>
          </div>
 
          <div class="object-meta-card">
            <div class="object-meta-label">Partition count</div>
            <div class="object-meta-value">
              {{ object_meta.extras.partition_count or 0}}
            </div>
          </div>
 
          {% elif obj_type == 'PROCEDURE' %}
          <div class="object-meta-card">
            <div class="object-meta-label">Parameters</div>
            <div class="object-meta-value">
              {% if object_meta.extras.parameters %}
              {{ object_meta.extras.parameters | length }} parameter(s)
              {% else %}
              None
              {% endif %}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Uses temp tables</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_temp_tables else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Uses transactions</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_transactions else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Uses cursor</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_cursor else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Uses WHILE loop</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_while_loop else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Uses triggers</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_triggers else 'No' }}
            </div>
          </div>
 
          {% elif obj_type == 'VIEW' %}
          <div class="object-meta-card">
            <div class="object-meta-label">Indexed view</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.is_indexed_view else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Schema bound</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.is_schema_bound else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Uses cursor</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_cursor else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Uses WHILE loop</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_while_loop else 'No' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Touches triggers</div>
            <div class="object-meta-value">
              {{ 'Yes' if object_meta.extras.uses_triggers else 'No' }}
            </div>
          </div>
 
          {% elif obj_type == 'FUNCTION' %}
          <div class="object-meta-card">
            <div class="object-meta-label">Function type</div>
            <div class="object-meta-value">
              {{ object_meta.extras.function_type or 'N/A' }}
            </div>
          </div>
          <div class="object-meta-card">
            <div class="object-meta-label">Return type</div>
            <div class="object-meta-value">
              {{ object_meta.extras.return_data_type or 'N/A' }}
            </div>
          </div>
          {% endif %}
        </div>
      </section>
 
      <!-- 1b. Type-specific extra details -->
      <section class="object-extra-section">
        {% if obj_type == 'PROCEDURE' and object_meta.extras.parameters %}
        <div class="object-extra-card">
          <div class="object-extra-title">Stored procedure parameters</div>
          <div class="object-extra-scroll">
            <table class="object-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Data type</th>
                  <th>Direction</th>
                  <th>Length / Precision</th>
                </tr>
              </thead>
              <tbody>
                {% for p in object_meta.extras.parameters %}
                <tr>
                  <td><code>{{ p.name }}</code></td>
                  <td>{{ p.data_type }}</td>
                  <td>
                    {% if p.is_output %}
                    OUTPUT
                    {% else %}
                    INPUT
                    {% endif %}
                  </td>
                  <td>
                    {% if p.precision or p.scale %}
                    {{ p.precision }}{% if p.scale is not none %}, {{ p.scale }}{% endif %}
                    {% elif p.max_length %}
                    {{ p.max_length }}
                    {% else %}
                    -
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </section>
 
      <section class="object-extra-section">
        {% if obj_type == 'PROCEDURE' %}
        <div class="object-extra-card">
          <div class="object-extra-title" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
            <span>Execution stats</span>
            {% set has_plan = object_meta.extras.has_plan if object_meta.extras and object_meta.extras.has_plan is not none else false %}
            <a class="btn btn-sm btn-outline-primary {{ 'disabled' if not has_plan else '' }}"
              href="{{ url_for('download_sqlplan', server_id=server.id, db_name=db.database_name, name=object_meta.full_name) if has_plan else '#' }}"
              {% if not has_plan %}aria-disabled="true" tabindex="-1"{% endif %}
              title="{% if has_plan %}Download cached execution plan (.sqlplan){% else %}Plan not available (SP not executed / not in cache){% endif %}">
              Download plan
            </a>
          </div>
          <div class="object-extra-scroll">
            <table class="object-table">
              <thead>
                <tr>
                  <th>Last execution time</th>
                  <th>Executions</th>
                  <th>Avg duration (s)</th>
                  <th>Last duration (s)</th>
                  <th>Avg CPU (s)</th>
                  <th>Last CPU (s)</th>
                  <th>Avg logical reads</th>
                  <th>Last logical reads</th>
                </tr>
              </thead>
              <tbody>
                {% if object_meta.extras.exec_history %}
                {% for h in object_meta.extras.exec_history %}
                <tr>
                  <td>{{ h.last_execution_time or 'N/A' }}</td>
                  <td>{{ h.execution_count or 0 }}</td>
 
                  <td>
                    {% if h.avg_duration_ms is not none %}
                    {{ '%.2f'|format(h.avg_duration_ms) }}
                    {% else %}
                    N/A
                    {% endif %}
                  </td>
                  <td>
                    {% if h.last_duration_ms is not none %}
                    {{ '%.2f'|format(h.last_duration_ms) }}
                    {% else %}
                    N/A
                    {% endif %}
                  </td>
 
                  <td>
                    {% if h.avg_cpu_ms is not none %}
                    {{ '%.2f'|format(h.avg_cpu_ms) }}
                    {% else %}
                    N/A
                    {% endif %}
                  </td>
                  <td>
                    {% if h.last_cpu_ms is not none %}
                    {{ '%.2f'|format(h.last_cpu_ms) }}
                    {% else %}
                    N/A
                    {% endif %}
                  </td>
 
                  <td>
                    {% if h.avg_logical_reads is not none %}
                    {{ h.avg_logical_reads|round(0, 'floor')|int }}
                    {% else %}
                    N/A
                    {% endif %}
                  </td>
                  <td>{{ h.last_logical_reads or 0 }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                  <td>N/A</td>
                  <td>N/A</td>
                  <td>N/A</td>
                  <td>N/A</td>
                  <td>N/A</td>
                  <td>N/A</td>
                  <td>N/A</td>
                  <td>N/A</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </section>
 
      {% if obj_type == 'TABLE' and object_meta.extras.indexes %}
      <section class="object-extra-section">
        <div class="object-extra-card">
          <div class="object-extra-title">Indexes</div>
          <div class="object-extra-scroll">
            <table class="object-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>PK</th>
                  <th>Unique</th>
                  <th>Key columns</th>
                  <th>Included columns</th>
                  <th>Used (MB)</th>
                  <th>Reserved (MB)</th>
                  <th>Fragmentation %</th>
                </tr>
              </thead>
              <tbody>
                {% for idx in object_meta.extras.indexes %}
                <tr>
                  <td><code>{{ idx.name }}</code></td>
                  <td>{{ idx.type_desc }}</td>
                  <td>{{ 'Yes' if idx.is_primary_key else 'No' }}</td>
                  <td>{{ 'Yes' if idx.is_unique else 'No' }}</td>
                  <td>{{ idx.key_columns | join(', ') if idx.key_columns else '-' }}</td>
                  <td>{{ idx.included_columns | join(', ') if idx.included_columns else '-' }}</td>
                  <td>{{ '%.2f'|format(idx.used_mb) if idx.used_mb is not none else '-' }}</td>
                  <td>{{ '%.2f'|format(idx.reserved_mb) if idx.reserved_mb is not none else '-' }}</td>
                  <td>{{ '%.1f'|format(idx.fragmentation_percent) if idx.fragmentation_percent is not none else '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
      {% endif %}
 
      <!-- 2. Dependencies -->
      <section class="object-deps-section">
        <div class="object-deps-card">
          <div class="object-deps-title">Objects referenced by this</div>
          <div class="object-deps-list">
            {% if object_meta.referenced %}
            {% for dep in object_meta.referenced %}
            {% set current_seg = (obj_type ~ '::' ~ object_meta.full_name) %}
            {% if trail_param %}
            {% set base_trail = trail_param %}
            {% else %}
            {% set base_trail = current_seg %}
            {% endif %}
            {% set next_trail = base_trail ~ '|' ~ (dep.object_type ~ '::' ~ dep.full_name) %}
            <div class="object-deps-item">
              <div class="object-deps-name">
                <a class="dep-link" data-full-name="{{ dep.full_name }}" href="{{ url_for('db_objects',
                    server_id=server.id,
                    db_name=db.database_name,
                    type=dep.object_type.lower(),
                    names=dep.full_name,
                    trail=next_trail) }}">
                  {{ dep.full_name }}
                </a>
              </div>
              <div class="object-deps-type">{{ dep.type_desc }}</div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-muted small">No dependencies found.</div>
            {% endif %}
          </div>
        </div>
 
        <div class="object-deps-card">
          <div class="object-deps-title">Objects that reference this</div>
          <div class="object-deps-list">
            {% if object_meta.referencing %}
            {% for dep in object_meta.referencing %}
            {% set current_seg = (obj_type ~ '::' ~ object_meta.full_name) %}
            {% if trail_param %}
            {% set base_trail = trail_param %}
            {% else %}
            {% set base_trail = current_seg %}
            {% endif %}
            {% set next_trail = base_trail ~ '|' ~ (dep.object_type ~ '::' ~ dep.full_name) %}
            <div class="object-deps-item">
              <div class="object-deps-name">
                <a class="dep-link" data-full-name="{{ dep.full_name }}" href="{{ url_for('db_objects',
                    server_id=server.id,
                    db_name=db.database_name,
                    type=dep.object_type.lower(),
                    names=dep.full_name,
                    trail=next_trail) }}">
                  {{ dep.full_name }}
                </a>
              </div>
              <div class="object-deps-type">{{ dep.type_desc }}</div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-muted small">No referencing objects found.</div>
            {% endif %}
          </div>
        </div>
      </section>
 
      {% endif %}
      {% endfor %}
      {% endif %}
    </div>
  </div>
 
  <!-- ===== DSX FOOTER ===== -->
  <footer class="dsx-footer">
    <div class="dsx-footer-inner">
      © Inventory Management · DataSolveX
    </div>
  </footer>
  <!-- ===== /DSX FOOTER ===== -->
 
  <script>
    const OBJ_LISTS = {{ obj_lists | tojson }};
    const selectedType = "{{ selected_type or 'TABLE' }}";
    const selectedNames = {{ selected_names | tojson if selected_names else '[]' }};
 
    function mapTypeToKey(typeValue) {
      switch ((typeValue || "").toLowerCase()) {
        case "table":
        case "tables":
          return "TABLE";
        case "view":
        case "views":
          return "VIEW";
        case "procedure":
        case "procedures":
        case "proc":
        case "sp":
          return "PROCEDURE";
        case "function":
        case "functions":
        case "func":
          return "FUNCTION";
        default:
          return "TABLE";
      }
    }
 
    function updateToggleLabel() {
      const container = document.getElementById("objects-container");
      const labelSpan = document.getElementById("objects-toggle-label");
      if (!container || !labelSpan) return;
 
      const checked = container.querySelectorAll('input[type="checkbox"]:checked');
      if (checked.length === 0) {
        labelSpan.textContent = "Select objects...";
      } else if (checked.length === 1) {
        labelSpan.textContent = checked[0].value;
      } else {
        labelSpan.textContent = checked.length + " objects selected";
      }
    }
 
    function renderObjectList(typeValue, searchTerm) {
      const key = mapTypeToKey(typeValue);
      const list = OBJ_LISTS[key] || [];
      const container = document.getElementById("objects-container");
      container.innerHTML = "";
 
      const filter = (searchTerm || "").toLowerCase();
 
      list.forEach(obj => {
        const fullName =
          obj.full_name ||
          (obj.schema_name && obj.object_name
            ? obj.schema_name + "." + obj.object_name
            : "");
 
        if (!fullName) return;
        if (filter && !fullName.toLowerCase().includes(filter)) return;
 
        const label = document.createElement("label");
        label.className = "multi-select-item";
 
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.name = "names";
        cb.value = fullName;
        if (selectedNames.includes(fullName)) {
          cb.checked = true;
        }
        cb.addEventListener("change", updateToggleLabel);
 
        const span = document.createElement("span");
        span.textContent = fullName;
 
        label.appendChild(cb);
        label.appendChild(span);
        container.appendChild(label);
      });
 
      updateToggleLabel();
    }
 
    document.addEventListener("DOMContentLoaded", () => {
      const typeSelect = document.getElementById("type-select");
      const searchInput = document.getElementById("objects-search");
      const toggleBtn = document.getElementById("objects-toggle");
      const dropdown = document.getElementById("objects-dropdown");
 
      const initialType = (typeSelect && typeSelect.value) || selectedType || "TABLE";
      renderObjectList(initialType, "");
 
      const downloadBtn = document.getElementById("download-btn");
      if (downloadBtn) {
        downloadBtn.addEventListener("click", (e) => {
          e.preventDefault();
 
          const base = downloadBtn.getAttribute("formaction") || "";
          if (!base) return;
 
          const params = new URLSearchParams();
          const t = (typeSelect && typeSelect.value) ? typeSelect.value : "table";
          params.set("type", t);
 
          const container = document.getElementById("objects-container");
          const checked = container ? container.querySelectorAll('input[type="checkbox"][name="names"]:checked') : [];
          checked.forEach(cb => params.append("names", cb.value));
          if (![...checked].length) return;
 
          const url = base + "?" + params.toString();
          window.location.assign(url);
        });
      }
 
      if (typeSelect) {
        typeSelect.addEventListener("change", () => {
          if (searchInput) searchInput.value = "";
          renderObjectList(typeSelect.value, "");
        });
      }
 
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          const currentType = typeSelect ? typeSelect.value : "table";
          renderObjectList(currentType, searchInput.value);
        });
      }
 
      if (toggleBtn && dropdown) {
        toggleBtn.addEventListener("click", () => {
          dropdown.classList.toggle("open");
        });
 
        document.addEventListener("click", (evt) => {
          if (!dropdown.contains(evt.target) && !toggleBtn.contains(evt.target)) {
            dropdown.classList.remove("open");
          }
        });
      }
 
      document.querySelectorAll(".dep-link").forEach(link => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          window.location.assign(link.href);
        });
      });
 
      updateToggleLabel();
    });
  </script>
 
  <script>
    const EXEC_PLANS = [
      {% set ns = namespace(first = true) %}
    {% for obj in selected_objects %}
    {% if obj.meta and obj.type == 'PROCEDURE' and obj.meta.extras.exec_plan_xml %}
    {% if not ns.first %}, {% endif %}
    {% set ns.first = false %}
    {
      containerId: "exec-plan-container-{{ loop.index }}",
        xml: {{ obj.meta.extras.exec_plan_xml | tojson }}
    }
    {% endif %}
    {% endfor %}
    ];
 
    document.addEventListener('DOMContentLoaded', function () {
      if (!window.QP || typeof QP.showPlan !== 'function') {
        console.warn('html-query-plan not available');
        return;
      }
 
      EXEC_PLANS.forEach(function (p) {
        const el = document.getElementById(p.containerId);
        if (!el || !p.xml) return;
 
        try {
          QP.showPlan(el, p.xml);
        } catch (e) {
          console.error('Failed to render plan for', p.containerId, e);
          el.textContent = 'Could not render graphical plan.';
        }
      });
    });
  </script>
 
</body>
</html>
 
 